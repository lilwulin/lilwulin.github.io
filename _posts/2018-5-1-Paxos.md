---
layout: post
title: 帕索斯岛上的议会：关于一致性的寓言
---

一个爱琴海上的小岛城邦，一群不务正业的议员和信使，是怎样通过一个协议使得议会能够正常运转的？这个情景来自于[Leslie Lamport](https://en.wikipedia.org/wiki/Leslie_Lamport)1989年写就的一篇著名论文[*The Part-Time Parliament*](https://lamport.azurewebsites.net/pubs/lamport-paxos.pdf)。这篇论文里介绍的Paxos协议，如今几乎成为了分布式系统一致性协议的同义词。在这篇博文里，我们一起了解一下什么是一致性问题以及Paxos有趣的背景故事，然后学习Paxos最简单的版本，再通过扩展简单版本得到一个可以用于数据库等有状态进程的Paxos协议。


## 背景故事
最初的论文虚构了Paxos这样一个古希腊海岛城邦，以及介绍了以它名字命名的一致性协议。整个情景是这样的：因为要外出做生意，议会里面的议员们并非全职工作，他们可能待了一阵又要离开，或者要去休假，或者再也不回来（分布式节点宕机、重启）。议员们说话很小声，所以要把要说的话写在纸片上让信使传递给其他议员。信使同样也不务正业，可能中途离开去出海，个把月再回来，或者把信弄丢、送重复（网络包丢失、重复、超时）。各个议员手持一张羊皮纸，通过及记录法令（节点达成一致）。整个议会在Paxos的一群数学家设计的协议下正常运行。

论文中虚构的场景其实是在描述分布式系统中的一致性问题（Consensus Problem）。一个集合中的进程，都可以提出一个值。你可以将这个值看成是任何东西，对于Paxos议会来说，它是单独一条法令，对一个分布式系统来说，它可以是单独一条log entry。最后集合中的进程需要达成共识，选定同一个值。这就是Paxos等一致性协议需要解决的问题。一个分布式系统可以通过一致性协议，将状态变化复制到多个节点上，这样节点在重启、结束、网络中断等意外发生的时候，其他节点可以继续运行，系统得以实现高可用（high availability）。

*The Part-Time Parliament*的发表也是一个有趣的故事，Leslie Lamport本人记录下了这段[野史](http://lamport.azurewebsites.net/pubs/pubs.html#lamport-paxos)。作者在论文里假装考古学家，借用希腊字母和夹杂着几分冷幽默，使得后来很多人抱怨这篇论文晦涩难懂。于是在2001年Leslie又发表了[*Paxos Made Simple*](https://lamport.azurewebsites.net/pubs/paxos-simple.pdf)。第二篇论文直截了当地描述了Paxos的运作过程，展示了Paxos原本的简洁设计，不过也丢失了一些趣味性和数学证明。

## 单值Paxos
在介绍完整的Paxos之前，我们先了解一下最简单的单值（Single-Decree）Paxos。我们可以假设整个分布式系统只需要维护一个变量。这个版本的Paxos只要做一件事，就是为这个变量选定一个值。

在*Paxos Made Simple*中，进程可以扮演三种角色：**Proposer**，**Acceptor**，**Learner**。为了解释方便，这篇博文只会使用到Proposer和Acceptor两种角色。顾名思义，Proposer的工作是向所有进程提出一个值；Acceptor的工作是接受Proposer提出的值。如果Proposer提出来的值被大多数进程接受（accept）了，那我们就说这个值被选择（chosen）了。

我们的大多数是指至少超过半数。这样的话，小于一半的进程运行失败了，我们还会有至少一个进程保留着正确的值。这意味着Paxos的集群中如果有5个节点，那么最多可以有2个节点失败。如果有7个节点，那么最多可以有3个节点失败。一个值如果被chosen，那么我们分布式系统维护的变量就只能选定这个值，不会再做出改变。选定之后不能再做出改变的原因是：因为我们需要保证高可用但同时需要节点能继续运行，所以我们只需要超过半数的节点同意一个值。但如果我们允许变量的值可以变化，假如第一次proposal，超过半数的节点同意一个值；第二次proposal，另外一些超过半数的节点同意另外一个值。那么至少有一个节点经历了两次proposal。假设唯一一个经历了两次proposal的节点失败了，那么集群中就会有刚好一半的节点同意一个值，而另外一半的节点同意另外一个值，我们没办法判断哪一个才是正确的。为了避免这种混淆的情况，Paxos规定了值被选定了之后，就不能再变化。既然只能选定一个值，又可能存在多个proposal，那么我们必须要有顺序号来标注每次proposal，这样Acceptor才能分辨出proposal的先后顺序，选定正确的值。

Paxos的运行过程分为两个phase，过程如下：
1. Phase 1:
	<ol type="a">
	<li>
		aaa
	</li>
	<li>
		bbb
	</li>
	</ol>
2. Phase 2:
  <ol type="a">
	<li>
		aaa
	</li>
	<li>
		bbb
	</li>
	</ol>



## 多值Paxos

## 引用材料
1. [The Part-Time Parliament](https://lamport.azurewebsites.net/pubs/lamport-paxos.pdf)
2. [Paxos Made Simple](https://lamport.azurewebsites.net/pubs/paxos-simple.pdf)
3. [Paxos Lecture](https://youtu.be/JEpsBg0AO6o)


